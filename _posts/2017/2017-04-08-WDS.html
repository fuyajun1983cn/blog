---
layout: post
date: 2017-04-08
author: 山庄来客
update: 2017-04-08
categories: wifi
---
<div id="content">
<h1 class="title">WDS</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. WDS</a>
<ul>
<li><a href="#sec-1-1">1.1. Setting up a WDS peer</a></li>
<li><a href="#sec-1-2">1.2. Using 4-address for AP and client mode</a></li>
<li><a href="#sec-1-3">1.3. Setting Up WDS</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> WDS</h2>
<div class="outline-text-2" id="text-1">
<p>
Wireless Distribution System. 
</p>

<div class="figure">
<p><img src="/images/2017/2017040701.png" alt="2017040701.png" />
</p>
</div>
<div class="note">
  <h5>提示</h5>
  <p>
    Same channel, Encryption KEY of WDS link， SSID可以不一样。
  </p>
</div>

<p>
帧格式：
</p>

<div class="figure">
<p><img src="/images/2017/2017040702.png" alt="2017040702.png" />
</p>
</div>

<p>
WDS Modes:
</p>
<ul class="org-ul">
<li>Bridge (Ap without beacon sending)
</li>
<li>Repeater (Ap with beacon sending)
</li>
</ul>

<p>
No Loop Topology:
</p>


<div class="figure">
<p><img src="/images/2017/2017040703.png" alt="2017040703.png" />
</p>
</div>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Setting up a WDS peer</h3>
<div class="outline-text-3" id="text-1-1">
<p>
WDS是IEEE 802.11的一个非标准扩展。 由于它是一个非标准扩展，各家芯
片厂商的驱动和固件实现都不一样，无法做到兼容，所以为了使用WDS， AP
和Repeater等无线设备的硬件和软件必须相同，以保证兼容。（不能是AP属
于一个厂商，Repeater来自另外一个厂商）。
</p>

<p>
创建一个WDS Peer的命令如下：
</p>
<div class="org-src-container">

<pre class="src src-sh">iw phy phy0 interface add wds0 type wds
iw dev wds0 set peer &lt;MAC address&gt;
</pre>
</div>

<p>
为了能让WDS功能正常工作， 驱动必须实现cfg80211的一个回调函数：
<code>set_wds_peer()</code> 。 由于mac80211已经实现了该回调函数，所以对应的基
于mac80211的驱动只需要支持创建WDS类型的接口即可。 当WDS功能启用时，
TX数据时，会将802.11帧的头部的第一个地址换成peer的地址。 
</p>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Using 4-address for AP and client mode</h3>
<div class="outline-text-3" id="text-1-2">
<p>
In some situations it might be useful to run a network with an
Access Point and multiple clients, but with each client bridged to
a network behind it. For this to work, both the client and the AP
need to transmit 4-address frames, containing both source and
destination MAC addresses. 
</p>

<p>
Linux wireless has support for 4-address mode for AP and STAs but
each driver needs to define this capability explicitly. All
mac80211 drivers support 4-address mode if AP or STA modes of
operation are supported respectively. 
</p>

<p>
On the AP side you can enable 4-address frames for individual
clients by isolating them in separate AP VLANs which are
configured in 4-address mode. Such an AP VLAN will be limited to
one client only, and this client will be used as the destination
for all traffic on its interface, regardless of the destination
MAC address in the packet headers.  
</p>

<p>
hostapd启动时， <code>wds_sta</code> 必须置为1. 对于AP端时，驱动必须支持
<code>NL80211_IFTYPE_AP_VLAN</code> 接口类型，以及 wiphy flag
<code>WIPHY_FLAG_4ADDR_AP</code> 必须置起。 对于Client端，驱动必须支持
<code>NL80211_IFTYPE_STATION</code> 以及wiphy flag <code>WIPHY_FLAG_4ADDR_STATION</code>
必须置起。 
</p>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> Setting Up WDS</h3>
<div class="outline-text-3" id="text-1-3">
<ol class="org-ol">
<li>On AP side, when writing hostapd configuration file, make sure
to add: 
<div class="org-src-container">

<pre class="src src-sh">wds_sta=1
wds_bridge=br0
</pre>
</div>

<p>
When <code>4-address</code> enabled WDS client connects, an interface
appears with a name of <code>wlan0.sta1</code> (I am assuming additional
interfaces will appear as <code>wlan0.sta2</code> and so on if more
4-address enabled clients connect).  
</p>

<p>
The <code>wds_bridge</code> line in the hostapd configuration file will
automatically add the wlan0.sta to your nominated bridge,
e.g. br0. Alternatively, you can always do <code>brctl addif</code> and so
on.  
</p>

<p>
As one would hope, non 4-address clients continue to work as
normal and co-exist with 4-address clients.
</p>
</li>

<li>On STA side, as specified in documentation, the interface has
to be brought up with 4addr on option, e.g. 
<pre class="example">
iw phy phy0 interface add wlan_sta0 type station 4addr on
</pre>

<p>
Bridge the 4-addr mode client interface (which is now connected
to AP side) wlan<sub>sta0</sub> to AP, e.g.
</p>
<pre class="example">
brctl addif br0 wlan_sta0 wlan0
</pre>

<p>
Make sure you disable DHCP on this device as DHCP is already
enabled on AP side and remember STA is simply a layer 2 device
now. 
</p>

<p>
Reference:
</p>
<ul class="org-ul">
<li>Simple WDS without security between WDS peers, use
recommendations on
<a href="https://wireless.wiki.kernel.org/en/users/documentation/iw#setting_up_a_wds_peer">https://wireless.wiki.kernel.org/en/users/documentation/iw#setting_up_a_wds_peer</a>
</li>

<li>Not-so simple WDS, where WDS link is secured by the fact that
it is really a modified STA-AP link (with all supported
authentication options available), use recommendations on
<a href="https://wireless.wiki.kernel.org/en/users/documentation/iw#using_4-address_for_ap_and_client_mode">https://wireless.wiki.kernel.org/en/users/documentation/iw#using_4-address_for_ap_and_client_mode</a> .
</li>
</ul>
</li>
</ol>
</div>
</div>
</div>
</div>
